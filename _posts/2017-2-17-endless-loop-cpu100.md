---
layout: post
title: "æˆ‘æ•…æ„å†™äº†ä¸ªæ­»å¾ªç¯"
description: "æ²¡æœ‰è¸©è¿‡æ­»å¾ªç¯çš„å‘çš„ç¨‹åºå‘˜ä¸æ˜¯å¥½ç¨‹åºå‘˜"
date: 2017-2-17
tags: [Java]
comments: true
share: true 

---
å¯¼è‡´CPU100%çš„åŸå› å¾ˆå¤šï¼Œè€Œç¨‹åºä¸­å‡ºç°æ­»å¾ªç¯å°±æ˜¯åŸå› ä¹‹ä¸€ã€‚ç„¶è€Œï¼Œå¹¶ä¸æ˜¯æ¯ä¸ªäººåœ¨å·¥ä½œä¸­éƒ½æœ‰æœºä¼šè¸©ä¸­è¿™ä¸ªå‘ã€‚æˆ‘å°±æ˜¯å…¶ä¸­ä¸€ä¸ªæ²¡è¸©è¿‡çš„ã€‚äººç”Ÿä¼¼ä¹æœ‰äº›ä¸å®Œæ•´ã€‚

æ‰€ä»¥ï¼Œæˆ‘åšäº†ä¸€ä¸ªå¾ˆé‡è¦çš„å†³å®šï¼š**åœ¨ç¨‹åºä¸­å†™ä¸€ä¸ªæ­»å¾ªç¯ã€‚çœ‹çœ‹ä¼šå‘ç”Ÿä»€ä¹ˆäº‹æƒ…**ã€‚

å½“ç„¶ï¼Œä¸æ˜¯åœ¨ç”Ÿäº§ç¯å¢ƒã€‚ğŸ˜œ æˆ‘æ­å»ºäº†ä¸€ä¸ªå®éªŒç¯å¢ƒæ¥åšå®éªŒã€‚åªæ˜¯è¿™ä¸ªå®éªŒç¯å¢ƒ**ä¸ä»…**å¯ä»¥ç”¨äºè¿™ä¸ªæ­»å¾ªç¯å®éªŒã€‚ä»¥ä¸‹æ˜¯è¿™ä¸ªç¯å¢ƒçš„ç»“æ„å›¾ï¼š

![å®éªŒå®¤ç»“æ„]({{ site.baseurl }}/assets/images/2017-2-17-292372-4c451d9ef3b37ab1.png)
è¿˜æ˜¯è€æ ·å­ï¼Œä½¿ç”¨Vagrant + Virtualbox + Ansibleè‡ªåŠ¨åŒ–æ­ç¯å¢ƒã€‚ä»£ç åŠæ­å»ºæ­¥éª¤åœ¨æ–‡æœ«ã€‚

æˆ‘ä»¬ä¼šå†™ä¸€ä¸ªç®€å•çš„Spring MVC åº”ç”¨ï¼Œç„¶åå…¶ä¸­ä¸€ä¸ªæ¥å£é‡Œä¼šæœ‰æ­»å¾ªç¯ä»£ç ï¼š

```
    @RequestMapping(value = "/loop", method = RequestMethod.GET, produces = "application/json; charset=UTF-8")
    public void endlessLoop() {
        int i = 0;
        while (true) {
            System.out.println(i += 1);
        }
    }
```

ä»¥ä¸‹æ˜¯æˆ‘è‡ªå·±å°è¯•æ‰¾å‡ºè¿™ä¸ªæ­»å¾ªç¯çš„è¿‡ç¨‹ã€‚


### ä½¿ç”¨topï¼ŒæŸ¥çœ‹æ˜¯å“ªä¸ªè¿›ç¨‹çš„é—®é¢˜

æˆ‘è¯·æ±‚ä¸€æ¬¡ï¼š`http://192.168.88.10:9898/web/loop`

![07:13:36 cpu100%äº†]({{ site.baseurl }}/assets/images/2017-2-17-292372-e7afb1a7f5524fec.png)

ç„¶åï¼Œæˆ‘æ‰“å¼€æ–°çª—å£ï¼Œåˆè¯·æ±‚ä¸€æ¬¡


![07:22:28 CPU120%~130%ä¹‹é—´]({{ site.baseurl }}/assets/images/2017-2-17-292372-864eaa6befc3bdd5.png)

è¿™é‡Œï¼Œæˆ‘å¥½å¥‡CPUæ²¡æœ‰åˆ°200%ã€‚ä¸€ç›´åœ¨120%å’Œ130%ä¹‹é—´ã€‚P.S. æˆ‘ä¸€å®šæ˜¯æŸä¸ªçŸ¥è¯†ç‚¹ä¸ç‰¢å›ºï¼Œè¦ä¸ï¼Œä¸ä¼šæœ‰è¿™ä¸ªç–‘é—®ã€‚

### å †ç©ºé—´
å› ä¸ºä¸æ¶‰åŠJVMå †ç©ºé—´é—®é¢˜ï¼Œæ‰§è¡Œ `jstat -gcutil 32593 1s` æ²¡çœ‹å‡ºä»€ä¹ˆé—®é¢˜ã€‚32593ä¸ºJavaè¿›ç¨‹IDï¼Œ1sæŒ‡1ç§’æŠ½æ ·ä¸€æ¬¡ã€‚

![æŸ¥çœ‹å †ç©ºé—´GCæƒ…å†µ]({{ site.baseurl }}/assets/images/2017-2-17-292372-a4d954f013d39fb6.png)

### æ ˆ
å †æ²¡é—®é¢˜ï¼Œå°±çœ‹çœ‹æ˜¯å“ªä¸ªçº¿ç¨‹å ç”¨å¾—é«˜ã€‚
1. åˆ—å‡ºjavaè¿›ç¨‹çš„çº¿ç¨‹ï¼Œ`top -H -p <java è¿›ç¨‹pid>`
![æ‰¾åˆ°CPUå ç”¨é«˜çš„çº¿ç¨‹PID]({{ site.baseurl }}/assets/images/2017-2-17-292372-1af95af5be74988e.png)
1. å°†jvmçš„æ ˆdumpä¸‹æ¥
  `jstack -l <å…¶ä¸­ä¸€ä¸ªçº¿ç¨‹PID> >> stack.log`ï¼Œè¿™é‡Œæˆ‘é€‰3596ã€‚

1. åœ¨æ—¥å¿—ä¸­ï¼Œæ‰¾åˆ°ç›¸åº”çš„çº¿ç¨‹
  æˆ‘ä»¬éœ€è¦ä»æ ˆæ—¥å¿—ä¸­æ‰¾åˆ°ç›¸åº”çš„çº¿ç¨‹ï¼Œä½†ç”±äºæ ˆæ—¥å¿—ä¸­ä½¿ç”¨çš„16è¿›åˆ¶ï¼Œä½†æ˜¯topä¸­çš„PIDåˆæ˜¯10è¿›åˆ¶ï¼Œæ‰€ä»¥ï¼Œéœ€è¦æ‰‹å·¥å°†10è¿›åˆ¶çš„PIDè½¬æˆ16è¿›åˆ¶ã€‚3596çš„16è¿›åˆ¶è½¬æ˜¯0xe0c
![less stack.log ç„¶åæœ0xe0c]({{ site.baseurl }}/assets/images/2017-2-17-292372-410dacd26223800a.png)

### å°ç»“
å¥½å§ã€‚æˆ‘æ²¡æœ‰å› ä¸ºå†™è¿™ä¸ªæ­»å¾ªç¯å»çœ‹10å°æ—¶çš„æ— èŠç”µå½±ã€‚

é™„å½•ï¼š
* ä»£ç ï¼š[performance-labs](https://github.com/zacker330/performance-labs)
* å‡†å¤‡ç¯å¢ƒï¼šè™šæ‹Ÿæœºçš„è´¦å·å¯†ç éƒ½æ˜¯_vagrant_
  * git clone  git@github.com:zacker330/performance-labs.git
  * vagrant up
  * download jdk8 to ansible/roles/jdk8/files: [https://pan.baidu.com/s/1bpxfpvD](https://pan.baidu.com/s/1bpxfpvD)
  * ansible-playbook ./ansible/playbook.yml -i ./ansible/inventory -u vagrant -k
  * ansible-playbook ./ansible/init-mysql.yml -i ./ansible/inventory -u vagrant -k
  * cd ansible;chmode +x ./buildwarfile.sh;./buildwarfile.sh --> å°†ä¼šæç¤ºè¾“å…¥vagrantå¯†ç 
* è®¿é—®ï¼šhttp://192.168.88.10:9898/web/